#!/bin/sh
# push ì „ íƒœê·¸ ìë™ ìƒì„± (main/master push ì‹œ)

remote="$1"
url="$2"

echo "ğŸ”„ Pre-push Start"

while read local_ref local_sha remote_ref remote_sha; do
    # ë¸Œëœì¹˜ëª… ì¶”ì¶œ
    branch=$(echo $remote_ref | sed 's/refs\/heads\///')

    echo "ğŸ“¤ About to push branch: $branch"

    # main ë˜ëŠ” master ë¸Œëœì¹˜ë¥¼ pushí•˜ë ¤ëŠ” ê²½ìš°ì—ë§Œ íƒœê·¸ ìƒì„±
    if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then

        if [ -f "tags/default.txt" ]; then
            echo "ğŸ·ï¸  Detector Tag, Tag Created..."

            # tags/default.txtì—ì„œ ì •ë³´ ì½ê¸°
            tag_name=$(grep "^name:" tags/default.txt | cut -d':' -f2)
            tag_message=$(grep "^message:" tags/default.txt | cut -d':' -f2)

            if [ -n "$tag_name" ]; then
                # ì´ë¯¸ ê°™ì€ íƒœê·¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if git tag -l | grep -q "^$tag_name$"; then
                    echo "âš ï¸  The same tag already exists: '$tag_name'"
                else
                    # íƒœê·¸ ë©”ì‹œì§€ êµ¬ì„±
                    current_date=$(date '+%Y-%m-%d %H:%M:%S')
                    commit_hash=$(git rev-parse --short HEAD)

                    # messageê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
                    if [ -z "$tag_message" ]; then
                        tag_message="Auto-generated release"
                    fi

                    full_message="$tag_message

ğŸ“… ìƒì„± ë‚ ì§œ: $current_date
ğŸ”— ì»¤ë°‹ í•´ì‹œ: $commit_hash"

                    echo "âœ… Created Tag: $tag_name"
                    git tag -a "$tag_name" -m "$full_message"
                    echo "ğŸ·ï¸  Tag will be pushed with branch"
                fi
            else
                echo "âŒ Error: Not Found TagName in tags/default.txt"
            fi
        else
            echo "â„¹ï¸  No tags/default.txt file found"
        fi

    else
        echo "â„¹ï¸  TagCreate Skip (Not main/master branch)"
    fi
done

echo "ğŸ‰ Pre-push Completed"