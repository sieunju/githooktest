#!/bin/sh
# push Ï†Ñ ÌÉúÍ∑∏ ÏûêÎèô ÏÉùÏÑ± Î∞è Ìë∏Ïãú (main/master push Ïãú)

remote="$1"
url="$2"

echo "üîÑ Pre-push Start"

while read local_ref local_sha remote_ref remote_sha; do
    # Î∏åÎûúÏπòÎ™Ö Ï∂îÏ∂ú
    branch=$(echo $remote_ref | sed 's/refs\/heads\///')

    echo "üì§ About to push branch: $branch"

    # main ÎòêÎäî master Î∏åÎûúÏπòÎ•º pushÌïòÎ†§Îäî Í≤ΩÏö∞ÏóêÎßå ÌÉúÍ∑∏ ÏÉùÏÑ±
    if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then

        if [ -f "tags/default.txt" ]; then
            echo "üè∑Ô∏è  Detector Tag, Tag Created..."

            # tags/default.txtÏóêÏÑú Ï†ïÎ≥¥ ÏùΩÍ∏∞
            tag_name=$(grep "^name:" tags/default.txt | cut -d':' -f2)
            tag_message=$(grep "^message:" tags/default.txt | cut -d':' -f2)

            if [ -n "$tag_name" ]; then
                # Ïù¥ÎØ∏ Í∞ôÏùÄ ÌÉúÍ∑∏Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
                if git tag -l | grep -q "^$tag_name$"; then
                    echo "‚ö†Ô∏è  The same tag already exists: '$tag_name'"
                else
                    # ÌÉúÍ∑∏ Î©îÏãúÏßÄ Íµ¨ÏÑ±
                    current_date=$(date '+%Y-%m-%d %H:%M:%S')
                    commit_hash=$(git rev-parse --short HEAD)

                    # messageÍ∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ ÏÇ¨Ïö©
                    if [ -z "$tag_message" ]; then
                        tag_message="Auto-generated release"
                    fi

                    full_message="$tag_message

üìÖ ÏÉùÏÑ± ÎÇ†Ïßú: $current_date
üîó Ïª§Î∞ã Ìï¥Ïãú: $commit_hash"

                    echo "‚úÖ Created Tag: $tag_name"
                    git tag -a "$tag_name" -m "$full_message"

                    # ÌÉúÍ∑∏Î•º ÏõêÍ≤©Ïóê Ï¶âÏãú Ìë∏Ïãú
                    echo "üöÄ Push Tag to Remote..."
                    if git push "$remote" "$tag_name" 2>/dev/null; then
                        echo "‚úÖ Tag '$tag_name' Remote Push Success"
                    else
                        echo "‚ùå Tag Push Failed"
                    fi
                fi
            else
                echo "‚ùå Error: Not Found TagName in tags/default.txt"
            fi
        else
            echo "‚ÑπÔ∏è  No tags/default.txt file found"
        fi

    else
        echo "‚ÑπÔ∏è  TagCreate Skip (Not main/master branch)"
    fi
done

echo "üéâ Pre-push Completed"