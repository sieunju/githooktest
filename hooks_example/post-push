#!/bin/sh
# push 후 태그 자동 생성 (main/master push 시)

remote="$1"
url="$2"

echo "🔄 Post-push Start"

# 어떤 브랜치들이 push되었는지 확인
while read local_ref local_sha remote_ref remote_sha; do
    # 브랜치명 추출
    branch=$(echo $remote_ref | sed 's/refs\/heads\///')

    echo "📤 Pushed branch: $branch"

    # main 또는 master 브랜치가 push된 경우에만 태그 생성
    if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then

        if [ -f "tags/default.txt" ]; then
            echo "🏷️  Detector Tag, Tag Created..."

            # tags/default.txt에서 정보 읽기
            tag_name=$(grep "^name:" tags/default.txt | cut -d':' -f2)
            tag_message=$(grep "^message:" tags/default.txt | cut -d':' -f2)

            if [ -n "$tag_name" ]; then
                # 이미 같은 태그가 존재하는지 확인
                if git tag -l | grep -q "^$tag_name$"; then
                    echo "⚠️  The same tag already exists: '$tag_name'"
                else
                    # 태그 메시지 구성
                    current_date=$(date '+%Y-%m-%d %H:%M:%S')
                    commit_hash=$(git rev-parse --short HEAD)

                    # message가 비어있으면 기본 메시지 사용
                    if [ -z "$tag_message" ]; then
                        tag_message="Auto-generated release"
                    fi

                    full_message="$tag_message

📅 생성 날짜: $current_date
🔗 커밋 해시: $commit_hash
🌿 브랜치: $branch"

                    echo "✅ Created Tag: $tag_name"
                    git tag -a "$tag_name" -m "$full_message"

                    # Remote Push
                    echo "🚀 Push Tag to Remote..."
                    if git push "$remote" "$tag_name"; then
                        echo "✅ Tag '$tag_name' Remote Push Success"
                    else
                        echo "❌ Tag Push Fail. Manual: 'git push $remote $tag_name'"
                    fi
                fi
            else
                echo "❌ Error: Not Found TagName in tags/default.txt"
            fi
        else
            echo "ℹ️  No tags/default.txt file found"
        fi

    else
        echo "ℹ️  TagCreate Skip (Not main/master branch)"
    fi
done

echo "🎉 Post-push Completed"