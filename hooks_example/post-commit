#!/bin/sh
# ì»¤ë°‹ í›„ íƒœê·¸ ìë™ ìƒì„± (main/master ë¸Œëœì¹˜ ì „ìš©)

current_branch=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ”„ Post-commit Start"

# main ë˜ëŠ” master ë¸Œëœì¹˜ì—ì„œë§Œ íƒœê·¸ ìƒì„±
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then

    if [ -f "tags/default.txt" ]; then
        echo "ğŸ·ï¸  Detector Tag, Tag Created..."

        # tags/default.txtì—ì„œ ì •ë³´ ì½ê¸°
        tag_name=$(grep "^name:" tags/default.txt | cut -d':' -f2)
        tag_message=$(grep "^message:" tags/default.txt | cut -d':' -f2)

        if [ -n "$tag_name" ]; then
            # ì´ë¯¸ ê°™ì€ íƒœê·¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if git tag -l | grep -q "^$tag_name$"; then
                echo "âš ï¸  The same tag already exists: '$tag_name'"
            else
                # íƒœê·¸ ë©”ì‹œì§€ êµ¬ì„±
                current_date=$(date '+%Y-%m-%d %H:%M:%S')
                commit_hash=$(git rev-parse --short HEAD)

                # messageê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
                if [ -z "$tag_message" ]; then
                    tag_message="Auto-generated release"
                fi

                full_message="$tag_message

ğŸ“… ìƒì„± ë‚ ì§œ: $current_date
ğŸ”— ì»¤ë°‹ í•´ì‹œ: $commit_hash"

                echo "âœ… Created Tag: $tag_name"
                git tag -a "$tag_name" -m "$full_message"

                # Remote Push (ì›ê²© ì €ì¥ì†Œê°€ ìˆë‹¤ë©´)
                if git remote get-url origin >/dev/null 2>&1; then
                    echo "ğŸš€ Push Tag to Remote..."
                    if git push origin "$tag_name"; then
                        echo "âœ… Tag '$tag_name' Remote Push Success"
                    else
                        echo "âŒ Tag Push Fail. Manual: 'git push origin $tag_name'"
                    fi
                else
                    echo "â„¹ï¸  No remote repository configured"
                fi
            fi
        else
            echo "âŒ Error: Not Found TagName in tags/default.txt"
        fi
    else
        echo "â„¹ï¸  No tags/default.txt file found"
    fi

else
    echo "â„¹ï¸  TagCreate Skip (Not main/master branch)"
fi

echo "ğŸ‰ Post-commit Completed"