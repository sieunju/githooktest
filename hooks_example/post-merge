#!/bin/sh
# Î®∏ÏßÄ ÌõÑ Î∏åÎûúÏπò ÏûêÎèô Ï†ïÎ¶¨ (Clean mergeÎßå)
# chmod +x .git/hooks/post-merge
echo "üîÑ Post-merge Start"

# Î∏åÎûúÏπò Ï†ïÎ¶¨ (main, develop, release/* Ï†úÏô∏ÌïòÍ≥† Î™®Îëê ÏÇ≠Ï†ú)
echo "üßπ Clear Branch..."
deleted_branch=$(git reflog | grep "checkout: moving from" | head -1 | awk '{print $6}')

# Î≥¥Ìò∏Îêú Î∏åÎûúÏπòÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ ÏÇ≠Ï†ú
case "$deleted_branch" in
    main|master|develop|task/*)
        echo "üõ°Ô∏è  Branch Delete Skip (Protected: $deleted_branch)"
        ;;
    ""|HEAD)
        echo "‚ÑπÔ∏è  No branch to delete"
        ;;
    *)
        if [ -n "$deleted_branch" ]; then
            # Ï∂©Îèå Ïó¨Î∂Ä ÌôïÏù∏ - ÎßàÏßÄÎßâ Ïª§Î∞ã Î©îÏãúÏßÄ Í≤ÄÏÇ¨
            last_commit_msg=$(git log -1 --pretty=format:"%s")

            # Ï∂©Îèå Í¥ÄÎ†® ÌÇ§ÏõåÎìúÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
            if echo "$last_commit_msg" | grep -qEi "(conflict|resolve|fix.*merge|merge.*fix|manual.*merge)"; then
                echo "‚ö†Ô∏è  Conflict resolution detected in: '$last_commit_msg'"
                echo "üö´ Skipping auto-delete for safety: $deleted_branch"
                echo "üí° Please manually verify and delete: git branch -d $deleted_branch"
            else
                echo "‚úÖ Clean merge detected"
                echo "üóëÔ∏è  Deleting branch: $deleted_branch"

                # Î°úÏª¨ Î∏åÎûúÏπò ÏÇ≠Ï†ú
                if git branch -d "$deleted_branch" 2>/dev/null; then
                    echo "‚úÖ Local branch '$deleted_branch' deleted"
                else
                    echo "‚ö†Ô∏è  Local branch '$deleted_branch' delete failed (may not exist or unmerged)"
                fi

                # ÏõêÍ≤© Î∏åÎûúÏπò ÏÇ≠Ï†ú (ÏõêÍ≤© Ï†ÄÏû•ÏÜåÍ∞Ä ÏûàÍ≥† Ìï¥Îãπ Î∏åÎûúÏπòÍ∞Ä Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞)
                if git remote get-url origin >/dev/null 2>&1; then
                    if git ls-remote --exit-code --heads origin "$deleted_branch" >/dev/null 2>&1; then
                        if git push origin --delete "$deleted_branch" 2>/dev/null; then
                            echo "‚úÖ Remote branch 'origin/$deleted_branch' deleted"
                        else
                            echo "‚ö†Ô∏è  Remote branch 'origin/$deleted_branch' delete failed"
                        fi
                    else
                        echo "‚ÑπÔ∏è  Remote branch 'origin/$deleted_branch' does not exist"
                    fi
                else
                    echo "‚ÑπÔ∏è  No remote repository configured"
                fi
            fi
        fi
        ;;
esac

echo "üéâ Post-merge Completed"